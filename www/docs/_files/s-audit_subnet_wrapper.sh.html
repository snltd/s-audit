<span class="Comment">#!/bin/ksh</span>

<span class="Comment">#=============================================================================</span>
<span class="Comment">#</span>
<span class="Comment"># s-audit_subnet_wrapper.sh</span>
<span class="Comment"># -------------------------</span>
<span class="Comment">#</span>
<span class="Comment"># Simple wrapper to s-audit_subnet.sh. Create IP list file and copy it to a</span>
<span class="Comment"># remote host.</span>
<span class="Comment">#</span>
<span class="Comment"># Part of s-audit. (c) 2011 SearchNet Ltd</span>
<span class="Comment">#   see <a href="http://snltd.co.uk/s-audit">http://snltd.co.uk/s-audit</a> for licensing and documentation</span>
<span class="Comment">#</span>
<span class="Comment">#=============================================================================</span>

<span class="Comment">#-----------------------------------------------------------------------------</span>
<span class="Comment"># VARIABLES</span>

<span class="Identifier">PATH</span>=/usr/bin
    <span class="Comment"># Always set your PATH</span>

<span class="Identifier">AUD_NET_SCR</span>=<span class="Statement">&quot;</span><span class="Constant">/usr/local/bin/s-audit_subnet.sh</span><span class="Statement">&quot;</span>
    <span class="Comment"># Path to s-audit_subnet.sh.</span>

<span class="Identifier">OUTFILE</span>=<span class="Statement">&quot;</span><span class="Constant">/var/tmp/s-audit_subnet.</span><span class="PreProc">${</span><span class="PreProc">RAND</span><span class="PreProc">}</span><span class="PreProc">$$</span><span class="Statement">&quot;</span>
    <span class="Comment"># File that will be written</span>

<span class="Identifier">REMOTE_STR</span>=<span class="PreProc">$1</span>
    <span class="Comment"># user@host</span>

<span class="Identifier">NETS</span>=<span class="Statement">&quot;</span><span class="Constant">10.10.4.0 10.10.6.0 10.10.7.0 10.10.8.0</span><span class="Statement">&quot;</span>
    <span class="Comment"># List of subnets to scan, space separated</span>

<span class="Comment">#-----------------------------------------------------------------------------</span>
<span class="Comment"># FUNCTIONS</span>

<span class="Identifier">die()</span>
<span class="Identifier">{</span>
    <span class="Comment"># Print an error and exit</span>

    <span class="Statement">print</span><span class="Constant"> -u2 </span><span class="Statement">&quot;</span><span class="Constant">ERROR: </span><span class="PreProc">$1</span><span class="Statement">&quot;</span>
    <span class="Statement">exit</span> <span class="PreProc">${</span><span class="PreProc">2</span><span class="Statement">:-</span>1<span class="PreProc">}</span>
<span class="Identifier">}</span>

<span class="Identifier">usage()</span>
<span class="Identifier">{</span>
    <span class="Comment"># Print usage and exit</span>

    <span class="Statement">print</span><span class="Constant"> </span><span class="Statement">&quot;</span><span class="Constant">usage: </span><span class="PreProc">${</span><span class="PreProc">0</span><span class="Statement">##</span>*/<span class="PreProc">}</span><span class="Constant"> user@host</span><span class="Statement">&quot;</span>
    <span class="Statement">exit</span> <span class="Constant">2</span>
<span class="Identifier">}</span>

<span class="Comment">#-----------------------------------------------------------------------------</span>
<span class="Comment"># SCRIPT STARTS HERE</span>

<span class="Comment"># Make sure we can see the network audit script</span>

<span class="Special">[[</span> <span class="Statement">-x</span> <span class="PreProc">$AUD_NET_SCR</span> <span class="Special">]]</span> <span class="Statement">\</span>
    || die <span class="Statement">&quot;</span><span class="Constant">can't execute subnet audit script. [</span><span class="PreProc">${</span><span class="PreProc">AUD_NET_SCR</span><span class="PreProc">}</span><span class="Constant">]</span><span class="Statement">&quot;</span>

<span class="Comment"># Make sure we can write to the outfile directory</span>

<span class="Special">[[</span> <span class="Statement">-w</span> <span class="PreProc">${</span><span class="PreProc">OUTFILE</span><span class="Statement">%</span>/*<span class="PreProc">}</span> <span class="Special">]]</span> <span class="Statement">\</span>
    || die <span class="Statement">&quot;</span><span class="Constant">can't write to </span><span class="PreProc">${</span><span class="PreProc">OUTFILE</span><span class="Statement">%</span>/*<span class="PreProc">}</span><span class="Constant">.</span><span class="Statement">&quot;</span>

<span class="Comment"># Start off with a header which says where and when the file was generated</span>

<span class="Statement">print</span><span class="Constant"> @@ </span><span class="PreProc">$(</span><span class="Special">uname -n</span><span class="PreProc">)</span><span class="Constant"> </span><span class="PreProc">$(</span><span class="Special">date </span><span class="Statement">&quot;</span><span class="Constant">+%H:%M %d/%m/%Y</span><span class="Statement">&quot;</span><span class="PreProc">)</span><span class="Constant"> </span><span class="Statement">&gt;</span><span class="PreProc">$OUTFILE</span>

<span class="Comment"># Run the script </span>

<span class="Statement">if </span><span class="PreProc">$AUD_NET_SCR</span> <span class="PreProc">$NETS</span> <span class="Statement">&gt;&gt;</span><span class="PreProc">$OUTFILE</span>
<span class="Statement">then</span>
    scp -qCp <span class="PreProc">$OUTFILE</span> <span class="PreProc">$REMOTE_STR</span> <span class="Statement">&gt;</span>/dev/null <span class="Constant">2</span><span class="Statement">&gt;</span><span class="Statement">&amp;</span><span class="Constant">1</span>\
        <span class="Statement">||</span> die <span class="Statement">&quot;</span><span class="Constant">failed to copy </span><span class="PreProc">$OUTFILE</span><span class="Constant"> to </span><span class="PreProc">${</span><span class="PreProc">REMOTE_STR</span><span class="PreProc">}</span><span class="Constant">.</span><span class="Statement">&quot;</span>

<span class="Statement">else</span>
    die <span class="Statement">&quot;</span><span class="Constant">failed to generate audit file at </span><span class="PreProc">${</span><span class="PreProc">OUTFILE</span><span class="PreProc">}</span><span class="Constant">.</span><span class="Statement">&quot;</span>
<span class="Statement">fi</span>

<span class="Statement">rm</span> <span class="Special">-f</span> <span class="PreProc">$OUTFILE</span>
